# Rétrospective Epic 3 — Navigation terrain & Suivi d'avancement

**Date :** 2026-02-10
**Facilitateur :** Bob (Scrum Master)
**Participants :** Alice (PO), Bob (SM), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Youssef (Project Lead)

---

## Résumé Epic 3

- **Stories :** 6/6 complétées (100%)
- **Tests :** 335 → 458 (123 nouveaux, 0 régressions)
- **Triggers SQL :** 5 fonctions en cascade (taches → pieces → lots → etages → plots → chantiers)
- **Realtime hooks :** 4 nouveaux (useRealtimeLots, useRealtimeEtages, useRealtimePlots, useRealtimePieces)
- **Composants UI :** BreadcrumbNav, TapCycleButton, PaginationDots, LotSearchBar, GridFilterTabs

## Succès

- **Triggers d'agrégation en cascade** — Actif technique le plus stratégique du projet. Agrégation serveur sur 5 niveaux, zéro logique côté client. Combinés aux hooks Realtime, les grilles colorées se mettent à jour en live.
- **TapCycleButton** — Interaction terrain parfaite : 1 tap = 1 changement de statut, feedback haptique, cycle 3 états. Pensé pour Bruno avec des gants.
- **Swipe natif sans librairie** — PointerEvents + seuil de vélocité (0.5px/ms). Léger, accessible (`motion-safe:`), pas de dépendance externe.
- **GridFilterTabs générique `<T>`** — Composant typé réutilisé sur 4 pages (plots, étages, lots, pièces). Abstraction justifiée par un vrai besoin répété.
- **Recherche cross-plot** — Join Supabase `plots!inner(nom)` + historique localStorage FIFO. Bruno trouve son lot en 1 seconde.
- **123 nouveaux tests, 0 régressions** — Discipline de test maintenue sur les 3 epics.

## Difficultés

- **Story 3-3 : 3 issues HIGH en code review** — Progress lots affiché incorrectement, hook Realtime manquant, collisions de tests entre mocks parallèles. La story la plus critique du projet avait le plus de bugs.
- **Edge cases du swipe** (3-4) — Latest-ref pattern pour éviter les closures stales, reset de slideDirection après animation, gestion vélocité + distance. 6 issues en review pour un seul composant de geste.
- **Flash visuel avec `useEffect`** (3-6) — Une frame de contenu non filtré visible avant application du filtre. Résolu par `useLayoutEffect`.
- **Complexité cachée > complexité visible** — Les stories "simples" en apparence (swipe, filtres) avaient plus de pièges que les stories ouvertement complexes (triggers, breadcrumb).

## Insights clés

1. Les triggers d'agrégation sont le coeur de l'app — à protéger, bien tester, documenter. Toute modification doit passer par une review dédiée.
2. La complexité cachée (gestes, timing de rendu) nécessite plus de vigilance en review que la complexité visible.
3. `useLayoutEffect` > `useEffect` quand le DOM doit être synchrone avant le paint.
4. Les PointerEvents natifs suffisent pour les interactions de geste simples — pas besoin de librairies.
5. Les composants génériques typés `<T>` sont le bon pattern pour la réutilisabilité multi-page.

## Suivi des actions Epic 2

- ✅ **Flaguer les stories denses** — Stories 3-3 et 3-1 identifiées comme denses.
- ⏳ **Centraliser les polyfills jsdom** — Pas encore fait. Pas de nouveau problème en Epic 3, mais risque pour Epic 4.
- ⏳ **Lint error ThemeProvider.tsx:64** — Troisième epic de suite. Toujours présent.

## Actions

### Améliorations de processus
1. **Renforcer la review sur les stories à complexité cachée** — Flag "complexité UX cachée" pour les composants de geste et de timing. Propriétaire : SM (Bob).
2. **Protéger les triggers d'agrégation** — Toute modification des triggers cascade passe par une review dédiée. Propriétaire : Dev (Amelia) + Architect (Winston).

### Dette technique
1. **Lint error ThemeProvider.tsx:64** — Report depuis Epic 1. Priorité basse.
2. **Centraliser les polyfills jsdom** — Report depuis Epic 2. Priorité moyenne.

### Accords d'équipe
- `useLayoutEffect` quand le DOM doit être synchrone avant le paint
- Composants génériques typés `<T>` pour la réutilisabilité multi-page
- PointerEvents natifs > librairies de gestes pour les interactions simples

## Préparation Epic 4 — Prérequis

### Critique (avant de commencer)
1. **Notes bloquantes et agrégation** — Définir l'interaction entre notes bloquantes et triggers d'agrégation. Une note bloquante empêche-t-elle une pièce d'être "done" ? Remonte-t-elle dans le progress ? Propriétaire : Alice (PO) + Winston (Architect). ⚠️ Impact direct sur le coeur de l'app.

### À clarifier (pendant l'implémentation)
2. **Supabase Storage** — Configuration buckets, policies RLS, compression client, stratégie offline. Propriétaire : Charlie (Senior Dev).
3. **Architecture du fil d'activité** — Table `activity_log` avec triggers vs query directe. Volume d'événements à évaluer. Propriétaire : Charlie (Senior Dev).

### Stratégie de test
4. **Tests caméra/photo en jsdom** — Définir l'approche pour les API navigateur (Camera, File, Blob). Mocks ou tests E2E séparés ? Propriétaire : Dana (QA).

## Évaluation de maturité

- **Tests & Qualité :** ✅ 458 tests, 0 régressions
- **Déploiement :** ✅ Production continue via Vercel + GitHub Actions
- **Triggers d'agrégation :** ✅ Fonctionnels sur 5 niveaux avec Realtime
- **Bloqueurs non résolus :** Aucun pour Epic 3. Prérequis identifiés pour Epic 4.

## Validation Epic suivante

L'Epic 4 (Notes, Photos & Collaboration) est en backlog. C'est un saut technique par rapport aux 3 premières epics : contenu binaire (photos/caméra), Supabase Storage, flux d'événements temps réel. 1 prérequis critique identifié (interaction notes bloquantes / agrégation), 3 points à clarifier. L'équipe est bien positionnée mais doit préparer ce nouveau territoire.
