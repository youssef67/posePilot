# Rétrospective Epic 5 — Gestion des Documents PDF

**Date :** 2026-02-11
**Facilitateur :** Bob (Scrum Master)
**Participants :** Alice (PO), Bob (SM), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Youssef (Project Lead)

---

## Résumé Epic 5

- **Stories :** 3/3 complétées (100%)
- **Tests :** 598 → 648 (50 nouveaux, 0 régressions)
- **Tasks :** 18 total (8 + 4 + 6)
- **Migrations SQL :** 2 (014_lot_documents_file, 015_lot_missing_docs)
- **Trigger functions :** 1 (update_lot_missing_docs)
- **Nouveaux composants :** DocumentSlot
- **Nouveaux hooks :** useUploadLotDocument, useReplaceLotDocument, useToggleLotDocumentRequired
- **Nouveaux utilitaires :** documentStorage (getDocumentSignedUrl, downloadDocument)
- **Première utilisation :** Supabase Storage bucket privé (`documents`), signed URLs avec expiration

## Succès

- **Réutilisation maximale des patterns** — Le pattern upload 2 phases (Epic 4) a été adapté directement pour les PDFs. Le trigger `has_missing_docs` reproduit exactement le pattern `has_blocking_note` (Epic 4). Le `DocumentSlot` suit le même design que les slots de notes. Temps de développement réduit grâce aux patterns établis.
- **Bucket privé vs public — choix architectural correct** — Le bucket `note-photos` (Epic 4) est public (photos partagées). Le bucket `documents` est privé (plans de pose, fiches de choix). URLs signées avec expiration 1h. Distinction claire et appropriée.
- **Scope discipliné** — 3 stories, 18 tasks. L'epic la plus compacte du projet. Chaque story avait un périmètre net : upload/download (5.1), toggle obligatoire (5.2), indicateurs manquants (5.3). Pas de scope creep.
- **Story 5.2 la plus petite du projet** — 4 tasks seulement. Un hook, une modification UI, un fix texte, régression. Preuve que le découpage en stories atomiques fonctionne.
- **Filtre "Avec alertes" étendu sans casser l'existant** — `getAlerts` passe de `has_blocking_note` seul à `has_blocking_note || has_missing_docs`. Le `GridFilterTabs` n'a pas été touché — la logique de filtre est côté page étage. Extension propre.
- **50 nouveaux tests, 0 régressions** — Discipline maintenue sur 5 epics consécutives. 648 tests au total.

## Difficultés

- **Safari/iOS — 2 issues HIGH** — Tous deux dans Story 5.1 :
  - `window.open` dans un callback async bloqué par le popup blocker Safari. Fix : pré-ouvrir la fenêtre de manière synchrone, puis naviguer après obtention de la signed URL.
  - `downloadDocument` ne fonctionne pas sur iOS Safari via blob URL + anchor download. Fix : utiliser signed URL avec Content-Disposition.
  - Safari/iOS est un générateur récurrent d'issues HIGH. 3 epics sur 5 ont eu des problèmes iOS.
- **Casts `as unknown as Type[]` toujours nécessaires** — Pattern récurrent depuis Epic 2. Le `Record<string, never>` dans `database.ts` force ces casts dans chaque hook. 5 epics avec le même contournement. Dette technique structurelle non résolue.
- **Code review volume stable** — Story 5.1 : 2H/3M/2L (7 issues). Story 5.2 : 6 issues. Story 5.3 : 4M. Total ~17 issues sur 3 stories. Le ratio est comparable aux epics précédentes — la review continue d'attraper des problèmes réels.

## Insights clés

1. Les patterns établis dans les epics précédentes (upload 2 phases, triggers cascade, mutation optimiste) sont devenus des accélérateurs. L'Epic 5 est la plus rapide grâce à cette capitalisation.
2. Le bucket privé avec signed URLs est le bon modèle pour les documents professionnels. Le bucket public reste approprié pour les photos partagées.
3. Safari/iOS est un risque systémique — considérer l'ajout de tests manuels iOS dans la checklist de review pour toute story touchant au Storage ou au `window.open`.
4. La séparation `useToggleLotDocumentRequired` vs `useToggleDocumentRequired` (variante) est un bon pattern — les mutations sur des tables différentes ne doivent jamais être mutualisées, même si la logique semble similaire.
5. `has_missing_docs` au niveau lot uniquement (pas de cascade) est le bon choix — les AC ne demandent pas d'indicateur aux niveaux supérieurs, et la cascade pourrait être ajoutée plus tard si nécessaire.

## Suivi des actions Epic 4

- ✅ **Checklist types pré-review** — Appliquée. Les types `LotDocument` (5.1) et `LotWithRelations` (5.3) ont été propagés correctement dès la première passe.
- ✅ **Checklist RLS pré-review** — Appliquée. Les RLS Storage dans 5.1 suivent le principe du moindre privilège (DELETE filtré par `auth.uid()`). Pas de policy trop permissive détectée.
- ❌ **Lint error ThemeProvider.tsx:64** — 5ème epic. Toujours présent. Priorité basse.
- ⏳ **Centraliser les mocks jsdom** — Pas de progression. Mocks Storage ajoutés dans chaque fichier test. Toujours éparpillés.

## Actions

### Améliorations de processus
1. **Checklist Safari/iOS pré-review** — Pour toute story touchant au Storage, `window.open`, ou download : vérifier le comportement sur Safari iOS (popup blocker, blob URLs, Content-Disposition). Propriétaire : Dev.
2. **Tests manuels iOS** — Ajouter une étape de test manuel sur iOS Safari pour les stories Storage/download avant de marquer "done". Propriétaire : QA.

### Dette technique
1. **Lint error ThemeProvider.tsx:64** — Report depuis Epic 1. 5 epics. Priorité basse mais persistant.
2. **Centraliser les mocks jsdom** — Report depuis Epic 3. Mocks Storage, `navigator.share`, `URL.createObjectURL`, `fetch blob`, `localStorage` éparpillés. Créer fichier partagé dans `src/test/`. Priorité basse.
3. **Types `database.ts` — `Record<string, never>`** — Cause racine des casts `as unknown as Type[]` partout. Résolution structurelle reportée — impact faible sur la productivité tant que le pattern de contournement est documenté.

### Accords d'équipe
- Bucket privé + signed URLs pour les documents professionnels (PDFs)
- Bucket public pour les photos partagées
- Triggers `has_*` au niveau lot uniquement sauf si les AC demandent explicitement une cascade
- Séparation des mutations par table cible (pas de mutualisation variante/lot)

## Préparation Epic 6

La prochaine epic est l'**Epic 6 : Besoins, Livraisons & Inventaire** (5 stories, backlog).

### Dépendances sur les Epics 1-5
- FAB menu (4.2) réutilisable pour "Nouveau besoin" / "Nouvelle livraison"
- Pattern Supabase Storage (4.2 + 5.1) pour les documents BC/BL (6.3)
- Badge BottomNavigation (4.4) à étendre pour les livraisons
- Trigger patterns (4.1, 5.3) pour l'agrégation inventaire (6.5)
- Mutation optimiste + upload 2 phases (4.2, 5.1) pour les attachments livraisons

### Points d'attention
- Agrégation inventaire (6.5) : nouveau système de triggers, distinct de celui des tâches
- Chantier léger (6.1) : premier flow différent selon le type de chantier
- 5 stories = epic la plus volumineuse depuis Epic 1
- Documents BC/BL (6.3) : réutiliser le pattern DocumentSlot + bucket privé

### Aucune préparation critique requise
Les patterns techniques nécessaires (Storage, triggers, FAB, Realtime, mutations optimistes) sont tous établis. Pas de sprint de préparation nécessaire.

## Évaluation de maturité

- **Tests & Qualité :** ✅ 648 tests, 0 régressions, 0 incident prod
- **Déploiement :** ✅ Production continue via Vercel + GitHub Actions
- **Supabase Storage :** ✅ 2 buckets opérationnels (note-photos public, documents privé)
- **Triggers SQL :** ✅ 6 trigger functions (aggregation, blocking_note cascade, activity_log x3, missing_docs)
- **Patterns de dev :** ✅ Capitalisation confirmée — Epic 5 la plus rapide grâce aux patterns des Epics 1-4
- **Bloqueurs non résolus :** Aucun. Epic 6 prête à démarrer.
